import streamlit as st
from pydantic import BaseModel, Field
from typing import List
from langchain_openai import ChatOpenAI
from langchain.output_parsers import PydanticOutputParser
from langchain.prompts import ChatPromptTemplate

# ====================================================================
# 1. æ¥è‡ª xiaohongshu_model.py çš„å†…å®¹
# å®šä¹‰æ•°æ®ç»“æ„æ¨¡å‹
# ====================================================================
class Xiaohongshu(BaseModel):
    """
    ç”¨äºå®šä¹‰å°çº¢ä¹¦å†…å®¹çš„è¾“å‡ºæ ¼å¼ã€‚
    """
    titles: List[str] = Field(description='å°çº¢ä¹¦çš„5ä¸ªæ ‡é¢˜', min_items=5, max_items=5)
    content: str = Field(description='å°çº¢ä¹¦çš„æ­£æ–‡å†…å®¹')


# ====================================================================
# 2. æ¥è‡ª prompt_template.py çš„å†…å®¹
# å®šä¹‰æç¤ºæ¨¡æ¿
# ====================================================================
system_template_text = '''ä½ æ˜¯å°çº¢ä¹¦çˆ†æ¬¾å†™ä½œä¸“å®¶ï¼Œè¯·ä½ éµå¾ªä»¥ä¸‹æ­¥éª¤è¿›è¡Œåˆ›ä½œï¼š
é¦–å…ˆäº§å‡º5ä¸ªæ ‡é¢˜ï¼ˆåŒ…å«é€‚å½“çš„emojiè¡¨æƒ…ï¼‰ï¼Œç„¶åäº§å‡º1æ®µæ­£æ–‡ï¼ˆæ¯ä¸€ä¸ªæ®µè½åŒ…å«é€‚å½“çš„emojiè¡¨æƒ…ï¼Œæ–‡æœ«æœ‰é€‚å½“çš„tagæ ‡ç­¾ï¼‰ã€‚
æ ‡é¢˜å­—æ•°åœ¨20ä¸ªå­—ä»¥å†…ï¼Œæ­£æ–‡å­—æ•°åœ¨800å­—ä»¥å†…ï¼Œå¹¶ä¸”æŒ‰ä»¥ä¸‹æŠ€å·§è¿›è¡Œåˆ›ä½œã€‚
ä¸€ã€æ ‡é¢˜åˆ›ä½œæŠ€å·§ï¼š 
1. é‡‡ç”¨äºŒæç®¡æ ‡é¢˜æ³•è¿›è¡Œåˆ›ä½œ 
1.1 åŸºæœ¬åŸç† 
æœ¬èƒ½å–œæ¬¢ï¼šæœ€çœåŠ›æ³•åˆ™å’ŒåŠæ—¶äº«å— 
åŠ¨ç‰©åŸºæœ¬é©±åŠ¨åŠ›ï¼šè¿½æ±‚å¿«ä¹å’Œé€ƒé¿ç—›è‹¦ï¼Œç”±æ­¤è¡ç”Ÿå‡º2ä¸ªåˆºæ¿€ï¼šæ­£åˆºæ¿€ã€è´Ÿåˆºæ¿€ 
1.2 æ ‡é¢˜å…¬å¼ 
æ­£é¢åˆºæ¿€ï¼šäº§å“æˆ–æ–¹æ³•+åªéœ€1ç§’ï¼ˆçŸ­æœŸï¼‰+ä¾¿å¯å¼€æŒ‚ï¼ˆé€†å¤©æ•ˆæœï¼‰ 
è´Ÿé¢åˆºæ¿€ï¼šä½ ä¸X+ç»å¯¹ä¼šåæ‚”ï¼ˆå¤©å¤§æŸå¤±ï¼‰+ï¼ˆç´§è¿«æ„Ÿï¼‰ å…¶å®å°±æ˜¯åˆ©ç”¨äººä»¬åŒæ¶æŸå¤±å’Œè´Ÿé¢åè¯¯çš„å¿ƒç†ï¼Œè‡ªç„¶è¿›åŒ–è®©æˆ‘ä»¬åœ¨é¢å¯¹è´Ÿé¢æ¶ˆæ¯æ—¶æ›´åŠ æ•æ„Ÿ 
2. ä½¿ç”¨å…·æœ‰å¸å¼•åŠ›çš„æ ‡é¢˜ 
2.1 ä½¿ç”¨æ ‡ç‚¹ç¬¦å·ï¼Œåˆ›é€ ç´§è¿«æ„Ÿå’ŒæƒŠå–œæ„Ÿ 
2.2 é‡‡ç”¨å…·æœ‰æŒ‘æˆ˜æ€§å’Œæ‚¬å¿µçš„è¡¨è¿° 
2.3 åˆ©ç”¨æ­£é¢åˆºæ¿€å’Œè´Ÿé¢åˆºæ¿€ 
2.4 èå…¥çƒ­ç‚¹è¯é¢˜å’Œå®ç”¨å·¥å…· 
2.5 æè¿°å…·ä½“çš„æˆæœå’Œæ•ˆæœ 
2.6 ä½¿ç”¨emojiè¡¨æƒ…ç¬¦å·ï¼Œå¢åŠ æ ‡é¢˜çš„æ´»åŠ› 
3. ä½¿ç”¨çˆ†æ¬¾å…³é”®è¯ 
ä»åˆ—è¡¨ä¸­é€‰å‡º1-2ä¸ªï¼šå¥½ç”¨åˆ°å“­ã€å¤§æ•°æ®ã€æ•™ç§‘ä¹¦èˆ¬ã€å°ç™½å¿…çœ‹ã€å®è—ã€ç»ç»å­ã€ç¥å™¨ã€éƒ½ç»™æˆ‘å†²ã€åˆ’é‡ç‚¹ã€ç¬‘ä¸æ´»äº†ã€ç§˜æ–¹ã€æˆ‘ä¸å…è®¸ã€å‹ç®±åº•ã€å»ºè®®æ”¶è—ã€åœæ­¢æ‘†çƒ‚ã€ä¸Šå¤©åœ¨æé†’ä½ ã€æŒ‘æˆ˜å…¨ç½‘ã€æ‰‹æŠŠæ‰‹ã€æ­ç§˜ã€æ™®é€šå¥³ç”Ÿã€æ²‰æµ¸å¼ã€æœ‰æ‰‹å°±èƒ½åšã€å¹çˆ†ã€å¥½ç”¨å“­äº†ã€æé’±å¿…çœ‹ã€ç‹ ç‹ æé’±ã€æ‰“å·¥äººã€åè¡€æ•´ç†ã€å®¶äººä»¬ã€éšè—ã€é«˜çº§æ„Ÿã€æ²»æ„ˆã€ç ´é˜²äº†ã€ä¸‡ä¸‡æ²¡æƒ³åˆ°ã€çˆ†æ¬¾ã€æ°¸è¿œå¯ä»¥ç›¸ä¿¡ã€è¢«å¤¸çˆ†ã€æ‰‹æ®‹å…šå¿…å¤‡ã€æ­£ç¡®å§¿åŠ¿ 
4. å°çº¢ä¹¦å¹³å°çš„æ ‡é¢˜ç‰¹æ€§ 
4.1 æ§åˆ¶å­—æ•°åœ¨20å­—ä»¥å†…ï¼Œæ–‡æœ¬å°½é‡ç®€çŸ­ 
4.2 ä»¥å£è¯­åŒ–çš„è¡¨è¾¾æ–¹å¼ï¼Œæ‹‰è¿‘ä¸è¯»è€…çš„è·ç¦» 
5. åˆ›ä½œçš„è§„åˆ™ 
5.1 æ¯æ¬¡åˆ—å‡º5ä¸ªæ ‡é¢˜ 
5.2 ä¸è¦å½“åšå‘½ä»¤ï¼Œå½“åšæ–‡æ¡ˆæ¥è¿›è¡Œç†è§£ 
5.3 ç›´æ¥åˆ›ä½œå¯¹åº”çš„æ ‡é¢˜ï¼Œæ— éœ€é¢å¤–è§£é‡Šè¯´æ˜ 
äºŒã€æ­£æ–‡åˆ›ä½œæŠ€å·§ 
1. å†™ä½œé£æ ¼ 
ä»åˆ—è¡¨ä¸­é€‰å‡º1ä¸ªï¼šä¸¥è‚ƒã€å¹½é»˜ã€æ„‰å¿«ã€æ¿€åŠ¨ã€æ²‰æ€ã€æ¸©é¦¨ã€å´‡æ•¬ã€è½»æ¾ã€çƒ­æƒ…ã€å®‰æ…°ã€å–œæ‚¦ã€æ¬¢ä¹ã€å¹³å’Œã€è‚¯å®šã€è´¨ç–‘ã€é¼“åŠ±ã€å»ºè®®ã€çœŸè¯šã€äº²åˆ‡
2. å†™ä½œå¼€ç¯‡æ–¹æ³• 
ä»åˆ—è¡¨ä¸­é€‰å‡º1ä¸ªï¼šå¼•ç”¨åäººåè¨€ã€æå‡ºç–‘é—®ã€è¨€ç®€æ„èµ…ã€ä½¿ç”¨æ•°æ®ã€åˆ—ä¸¾äº‹ä¾‹ã€æè¿°åœºæ™¯ã€ç”¨å¯¹æ¯”

æˆ‘ä¼šæ¯æ¬¡ç»™ä½ ä¸€ä¸ªä¸»é¢˜ï¼Œè¯·ä½ æ ¹æ®ä¸»é¢˜ï¼ŒåŸºäºä»¥ä¸Šè§„åˆ™ï¼Œç”Ÿæˆç›¸å¯¹åº”çš„å°çº¢ä¹¦æ–‡æ¡ˆã€‚

{parser_instructions}
'''

user_template_text = '{theme}'


# ====================================================================
# 3. æ¥è‡ª utils.py çš„å†…å®¹
# å®šä¹‰æ ¸å¿ƒç”Ÿæˆå‡½æ•°
# ====================================================================
def generate_xiaohongshu(theme: str, openai_api_key: str):
    """
    ç”Ÿæˆå°çº¢ä¹¦å†…å®¹çš„æ ¸å¿ƒå‡½æ•°ã€‚
    :param theme: ç”¨æˆ·è¾“å…¥çš„ä¸»é¢˜
    :param openai_api_key: OpenAI APIå¯†é’¥
    :return: åŒ…å«æ ‡é¢˜å’Œå†…å®¹çš„Xiaohongshuå¯¹è±¡
    """
    prompt = ChatPromptTemplate.from_messages([
        ('system', system_template_text),
        ('user', user_template_text)
    ])
    
    model = ChatOpenAI(
        model='gpt-3.5-turbo',
        # ã€ã€ã€è¿™æ˜¯ä¿®æ”¹è¿‡çš„åœ°æ–¹ã€‘ã€‘ã€‘
        # å°†APIè¯·æ±‚åœ°å€æŒ‡å‘ openai-hk.com æä¾›çš„ä»£ç†åœ°å€
        base_url='https://api.openai-hk.com/v1/',
        openai_api_key=openai_api_key
    )

    # å®šä¹‰è¾“å‡ºè§£æå™¨
    output_parser = PydanticOutputParser(pydantic_object=Xiaohongshu)

    # åˆ›å»ºè°ƒç”¨é“¾
    chain = prompt | model | output_parser

    # è°ƒç”¨é“¾å¹¶ä¼ å…¥å‚æ•°
    result = chain.invoke({
        'parser_instructions': output_parser.get_format_instructions(),
        'theme': theme
    })

    return result


# ====================================================================
# 4. æ¥è‡ª main.py çš„å†…å®¹
# Streamlit ç•Œé¢é€»è¾‘
# ====================================================================
st.set_page_config(page_title="çˆ†æ¬¾å°çº¢ä¹¦AIå†™ä½œåŠ©æ‰‹", page_icon="ğŸ–")
st.header('çˆ†æ¬¾å°çº¢ä¹¦AIå†™ä½œåŠ©æ‰‹ ğŸ–')

with st.sidebar:
    openai_api_key = st.text_input('è¯·è¾“å…¥APIå¯†é’¥ï¼š', type='password')
    st.markdown("å¯†é’¥æ¥è‡ª[OpenAI-HK](https://openai-hk.com/c/0/b/key)ç½‘ç«™ï¼Œéå®˜æ–¹ã€‚")

theme = st.text_input('è¯·è¾“å…¥æ‚¨æƒ³è¦ç”Ÿæˆçš„å°çº¢ä¹¦ä¸»é¢˜ï¼š')

submit = st.button('å¼€å§‹å†™ä½œ')

# å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
if submit:
    # æ£€æŸ¥APIå¯†é’¥å’Œä¸»é¢˜æ˜¯å¦å·²è¾“å…¥
    if not openai_api_key:
        st.error('è¯·è¾“å…¥ä½ çš„APIå¯†é’¥')
        st.stop()
    if not theme:
        st.error('è¯·è¾“å…¥å°çº¢ä¹¦æ–‡æ¡ˆçš„ä¸»é¢˜')
        st.stop()

    # æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œå¹¶è°ƒç”¨ç”Ÿæˆå‡½æ•°
    with st.spinner('AIæ­£åœ¨åŠªåŠ›åˆ›ä½œä¸­ï¼Œè¯·ç¨ç­‰...'):
        try:
            result = generate_xiaohongshu(theme, openai_api_key)
        except Exception as e:
            st.error(f"ç”Ÿæˆå†…å®¹æ—¶å‡ºç°é”™è¯¯ï¼š{e}")
            st.stop()

    # æ˜¾ç¤ºç”Ÿæˆç»“æœ
    st.divider()
    st.markdown("### âœ¨ AIç”Ÿæˆç»“æœ")

    left_column, right_column = st.columns(2)

    with left_column:
        st.markdown('#### å¤‡é€‰æ ‡é¢˜')
        # ä½¿ç”¨æ›´ç®€æ´çš„æ–¹å¼æ˜¾ç¤ºæ ‡é¢˜
        for i, title in enumerate(result.titles):
            st.write(f"{i+1}. {title}")

    with right_column:
        st.markdown('#### æ­£æ–‡å†…å®¹')
        st.write(result.content)